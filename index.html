<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TradeVRS - Trade Data Analysis</title>
  <style>
    :root {
      --background-color: #F5F7FA;
      --primary-color: #2F54EB;
      --card-bg: #FFFFFF;
      --card-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      --border-radius: 8px;
      --text-color: #333;
      --subtext-color: #555;
      --table-header-bg: #EFF2F7;
    }

    /* Loading indicator */
    .loading {
      display: none;
      color: var(--primary-color);
      font-weight: bold;
      padding: 10px;
    }
    .loading.active {
      display: block;
    }

    /* Connection status */
    .connection-status {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 8px 12px;
      border-radius: var(--border-radius);
      background: var(--card-bg);
      box-shadow: var(--card-shadow);
      font-size: 12px;
      z-index: 1000;
    }
    .connection-status.connected {
      border-left: 3px solid #4caf50;
    }
    .connection-status.disconnected {
      border-left: 3px solid #f44336;
    }

    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background-color: var(--background-color);
      margin: 0;
      padding: 0;
      color: var(--text-color);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      margin-bottom: 20px;
    }
    header h1 {
      font-size: 32px;
      margin: 0 0 10px 0;
      color: var(--text-color);
    }
    header p {
      margin: 0;
      color: var(--subtext-color);
      line-height: 1.5;
    }

    .card {
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      padding: 20px;
      margin-bottom: 20px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 20px;
    }
    .form-grid label {
      display: flex;
      flex-direction: column;
      font-weight: 600;
      color: var(--text-color);
    }
    .form-grid input[type="text"],
    .form-grid input[type="month"],
    .form-grid select {
      margin-top: 6px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: var(--border-radius);
      font-size: 14px;
      width: 100%;
      box-sizing: border-box;
    }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 20px;
    }
    button {
      cursor: pointer;
      border: none;
      border-radius: var(--border-radius);
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
    }
    #fetchBtn {
      background-color: var(--primary-color);
      color: #fff;
    }
    #downloadBtn {
      background-color: #E4E6EB;
      color: var(--text-color);
    }
    button[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .filter-grid {
      display: grid;
      grid-template-columns: 1fr auto 1fr 1fr 1fr;
      gap: 20px;
      margin-top: 16px;
      width: 100%;
      grid-column: 1 / -1;
    }
    .filter-box {
      display: flex;
      flex-direction: column;
      border-radius: var(--border-radius);
      padding: 8px;
      min-height: 220px;
    }
    .filter-box .box-label {
      font-weight: 600;
      color: var(--text-color);
      margin-bottom: 4px;
    }
    .filter-box select {
      min-height: 120px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: var(--border-radius);
      font-size: 14px;
      box-sizing: border-box;
      flex: 1;
      overflow-y: auto;
    }

    .filter-grid > .button-stack {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .filter-grid > .button-stack button {
      width: 100px;
      height: 36px;
      border-radius: var(--border-radius);
      font-size: 14px;
      font-weight: 600;
    }

    .add-country-btn {
      background-color: var(--primary-color);
      color: #fff;
    }
    .remove-country-btn {
      background-color: #E4E6EB;
      color: var(--text-color);
    }

    /* Table styles */
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th {
      background-color: var(--table-header-bg);
      color: var(--text-color);
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
      font-size: 14px;
    }
    td {
      border: 1px solid #ddd;
      padding: 8px;
      font-size: 14px;
    }
    tr:nth-child(even) td {
      background-color: #FAFBFD;
    }

    .dynamic-card {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Connection status indicator -->
  <div class="connection-status disconnected" id="connectionStatus">
    <span id="statusText">Connecting to API...</span>
  </div>

  <div class="container">
    <header>
      <h1>TradeVRS - Trade Data Analysis</h1>
      <p>
        Analyze U.S. import trade data by HTS codes and countries. 
        Data sourced from U.S. Census Bureau International Trade API.
      </p>
    </header>

    <!-- Loading indicator -->
    <div class="loading" id="loadingIndicator">Loading data from secure API...</div>

    <!-- Form card -->
    <div class="card form-card">
      <form id="tradeForm" onsubmit="return false;">
        <div class="form-grid">
          <label>
            Search Country:
            <input type="text" id="countrySearch" placeholder="Type to find country...">
          </label>
          <label>
            HTS Codes (comma-separated):
            <input type="text" id="htsCodes" placeholder="e.g. 9504500000, 8541404000">
          </label>
          <label>
            Start Month:
            <input type="month" id="startDate">
          </label>
          <label>
            End Month:
            <input type="month" id="endDate">
          </label>
          <label>
            Census API Key (optional):
            <input type="text" id="apiKey" placeholder="Leave blank for 500 requests/day">
          </label>

          <div class="filter-grid">
            <div class="filter-box country-box">
              <span class="box-label">Country:</span>
              <select id="countrySelect" multiple>
                <option value="">Loading countries...</option>
              </select>
            </div>
            <div class="button-stack">
              <button type="button" id="addCountryBtn" class="add-country-btn">Add</button>
              <button type="button" id="removeCountryBtn" class="remove-country-btn">Remove</button>
            </div>
            <div class="filter-box selected-box">
              <span class="box-label">Selected Countries:</span>
              <select id="selectedCountrySelect" multiple></select>
            </div>
            <div class="filter-box country-filter-box">
              <span class="box-label">Country Filter</span>
              <div id="countryFilterContainer"></div>
            </div>
            <div class="filter-box hts-filter-box">
              <span class="box-label">HTS Filter</span>
              <div id="htsFilterContainer"></div>
            </div>
          </div>
        </div>

        <div class="button-row">
          <button type="button" id="fetchBtn">Fetch Data</button>
          <button type="button" id="downloadBtn" disabled>Download CSV</button>
        </div>
      </form>
    </div>

    <!-- Results card -->
    <div class="card dynamic-card">
      <div id="results"></div>
    </div>
  </div>

  <script>
    // ========================================
    // API CONFIGURATION
    // ========================================
    const API_CONFIG = {
      baseUrl: 'https://tradevrs-backend.vercel.app',
      apiKey: 'test-key-123',
      endpoints: {
        health: '/api',
        countries: '/api/countries',
        units: '/api/units'
      }
    };

    // ========================================
    // GLOBAL VARIABLES
    // ========================================
    let countriesList = [];
    let countryNameMap = {};
    let unitNameMap = {};
    let selectedCountriesList = [];
    let isApiConnected = false;

    // ========================================
    // API CONNECTION FUNCTIONS
    // ========================================
    async function connectToAPI() {
      const statusEl = document.getElementById('connectionStatus');
      const statusText = document.getElementById('statusText');
      const loadingEl = document.getElementById('loadingIndicator');
      
      try {
        loadingEl.classList.add('active');
        statusText.textContent = 'Connecting to API...';
        
        // Test API connection
        const healthResponse = await fetch(API_CONFIG.baseUrl + API_CONFIG.endpoints.health);
        const healthData = await healthResponse.json();
        
        if (healthData.status !== 'ok') {
          throw new Error('API health check failed');
        }
        
        // Load countries
        statusText.textContent = 'Loading countries...';
        const countriesResponse = await fetch(API_CONFIG.baseUrl + API_CONFIG.endpoints.countries, {
          headers: {
            'x-api-key': API_CONFIG.apiKey
          }
        });
        
        if (!countriesResponse.ok) {
          throw new Error('Failed to load countries');
        }
        
        const countriesData = await countriesResponse.json();
        countriesList = countriesData.countries;
        
        // Build country name map
        countryNameMap = {};
        countriesList.forEach(country => {
          countryNameMap[country.code] = country.name;
        });
        
        // Load units
        statusText.textContent = 'Loading units...';
        const unitsResponse = await fetch(API_CONFIG.baseUrl + API_CONFIG.endpoints.units, {
          headers: {
            'x-api-key': API_CONFIG.apiKey
          }
        });
        
        if (!unitsResponse.ok) {
          throw new Error('Failed to load units');
        }
        
        unitNameMap = await unitsResponse.json();
        
        // Success!
        isApiConnected = true;
        statusEl.classList.remove('disconnected');
        statusEl.classList.add('connected');
        statusText.textContent = 'API Connected ✓';
        
        // Populate country dropdown
        populateCountryDropdown();
        
        console.log('API Connection Successful!');
        console.log(`Loaded ${countriesList.length} countries`);
        console.log(`Loaded ${Object.keys(unitNameMap).length} unit mappings`);
        
      } catch (error) {
        console.error('API Connection Failed:', error);
        statusEl.classList.add('disconnected');
        statusEl.classList.remove('connected');
        statusText.textContent = 'API Connection Failed ✗';
        alert('Failed to connect to backend API. Please refresh the page.');
      } finally {
        loadingEl.classList.remove('active');
      }
    }

    function populateCountryDropdown() {
      const select = document.getElementById('countrySelect');
      select.innerHTML = '';
      
      countriesList.forEach(entry => {
        const option = document.createElement('option');
        option.value = entry.code;
        option.textContent = entry.name;
        select.appendChild(option);
      });
      
      renderSelectedCountries();
    }

    function renderSelectedCountries() {
      const selectBox = document.getElementById('selectedCountrySelect');
      if (!selectBox) return;
      
      selectBox.innerHTML = '';
      
      if (selectedCountriesList.length === 0) {
        const option = document.createElement('option');
        option.disabled = true;
        option.value = '';
        option.textContent = 'No countries selected';
        selectBox.appendChild(option);
        return;
      }
      
      selectedCountriesList.forEach(entry => {
        const opt = document.createElement('option');
        opt.value = entry.code;
        opt.textContent = entry.name;
        opt.selected = true;
        selectBox.appendChild(opt);
      });
    }

    // ========================================
    // MAIN DATA FETCHING FUNCTION
    // ========================================
    async function fetchData() {
      if (!isApiConnected) {
        alert('API not connected. Please wait for connection or refresh the page.');
        return;
      }
      
      const htsInput = document.getElementById('htsCodes').value;
      const codes = htsInput.split(',').map(s => s.trim()).filter(s => s);
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const censusApiKey = document.getElementById('apiKey').value.trim();
      const resultsDiv = document.getElementById('results');
      
      // Validation
      if (codes.length === 0) {
        resultsDiv.innerHTML = '<p style="color: red;">Please enter at least one HTS code.</p>';
        return;
      }
      if (!startDate || !endDate) {
        resultsDiv.innerHTML = '<p style="color: red;">Please select both start and end dates.</p>';
        return;
      }
      
      // Get selected countries
      const selectedBox = document.getElementById('selectedCountrySelect');
      let countries = [];
      if (selectedBox) {
        Array.from(selectedBox.options).forEach(opt => {
          if (!opt.disabled && opt.value && opt.value !== 'ALL_COMBINED') {
            countries.push(opt.value);
          }
        });
      }
      
      // Build Census API call
      const baseUrl = 'https://api.census.gov/data/timeseries/intltrade/imports/hs';
      const vars = [
        'I_COMMODITY', 'CTY_CODE', 'CTY_NAME', 'YEAR', 'MONTH',
        'GEN_VAL_MO', 'CON_VAL_MO', 'GEN_QY1_MO', 'UNIT_QY1'
      ];
      
      resultsDiv.innerHTML = '<p>Fetching data from Census API...</p>';
      
      let allData = [];
      let errorCount = 0;
      
      // Process each HTS code
      for (const code of codes) {
        try {
          // Build query URL
          let url = `${baseUrl}?get=${vars.join(',')}`;
          url += `&I_COMMODITY=${code}`;
          url += `&COMM_LVL=HS10`;
          url += `&SUMMARY_LVL=DET`;
          url += `&time=from+${startDate}+to+${endDate}`;
          
          // Add countries if selected
          if (countries.length > 0) {
            countries.forEach(c => {
              url += `&CTY_CODE=${c}`;
            });
          }
          
          // Add API key if provided
          if (censusApiKey) {
            url += `&key=${censusApiKey}`;
          }
          
          resultsDiv.innerHTML = `<p>Fetching data for HTS ${code}...</p>`;
          
          const response = await fetch(url);
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          const data = await response.json();
          
          if (data && data.length > 1) {
            const headers = data[0];
            const rows = data.slice(1);
            
            rows.forEach(row => {
              const obj = {};
              headers.forEach((header, index) => {
                obj[header] = row[index];
              });
              obj.HTS_CODE = code;
              allData.push(obj);
            });
            
            resultsDiv.innerHTML = `<p style="color: green;">✓ Retrieved ${rows.length} records for HTS ${code}</p>`;
          } else {
            resultsDiv.innerHTML += `<p style="color: orange;">⚠️ No data found for HTS ${code}</p>`;
          }
          
        } catch (error) {
          errorCount++;
          console.error(`Error fetching HTS ${code}:`, error);
          resultsDiv.innerHTML += `<p style="color: red;">✗ Error fetching HTS ${code}: ${error.message}</p>`;
          
          if (error.message.includes('429')) {
            resultsDiv.innerHTML += `<p style="color: orange;">Rate limit reached. Consider adding a Census API key.</p>`;
          }
        }
        
        // Small delay between requests to avoid rate limiting
        await new Promise(resolve => setTimeout(resolve, 200));
      }
      
      // Display results
      if (allData.length > 0) {
        let html = `
          <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin: 20px 0;">
            <h3 style="color: #2e7d32;">✓ Trade Data Retrieved Successfully!</h3>
            <p><strong>Total Records:</strong> ${allData.length}</p>
            <p><strong>HTS Codes Processed:</strong> ${codes.length - errorCount} of ${codes.length}</p>
            <p><strong>Date Range:</strong> ${startDate} to ${endDate}</p>
          </div>
        `;
        
        html += '<table style="width:100%; border-collapse:collapse; margin-top: 20px;">';
        html += `
          <thead>
            <tr style="background:#f0f0f0;">
              <th style="border:1px solid #ddd;padding:8px;">HTS Code</th>
              <th style="border:1px solid #ddd;padding:8px;">Country</th>
              <th style="border:1px solid #ddd;padding:8px;">Year</th>
              <th style="border:1px solid #ddd;padding:8px;">Month</th>
              <th style="border:1px solid #ddd;padding:8px;">Import Value</th>
              <th style="border:1px solid #ddd;padding:8px;">Quantity</th>
              <th style="border:1px solid #ddd;padding:8px;">Unit</th>
            </tr>
          </thead>
          <tbody>
        `;
        
        // Show first 100 rows
        allData.slice(0, 100).forEach(row => {
          const value = parseInt(row.GEN_VAL_MO || 0).toLocaleString();
          const qty = parseInt(row.GEN_QY1_MO || 0).toLocaleString();
          const unit = unitNameMap[row.UNIT_QY1] || row.UNIT_QY1 || '-';
          
          html += '<tr>';
          html += `<td style="border:1px solid #ddd;padding:5px;">${row.HTS_CODE}</td>`;
          html += `<td style="border:1px solid #ddd;padding:5px;">${row.CTY_NAME || row.CTY_CODE}</td>`;
          html += `<td style="border:1px solid #ddd;padding:5px;">${row.YEAR}</td>`;
          html += `<td style="border:1px solid #ddd;padding:5px;">${row.MONTH}</td>`;
          html += `<td style="border:1px solid #ddd;padding:5px;text-align:right;">$${value}</td>`;
          html += `<td style="border:1px solid #ddd;padding:5px;text-align:right;">${qty}</td>`;
          html += `<td style="border:1px solid #ddd;padding:5px;">${unit}</td>`;
          html += '</tr>';
        });
        
        html += '</tbody></table>';
        
        if (allData.length > 100) {
          html += `<p style="color: #666; margin-top: 10px;">Showing first 100 of ${allData.length} records. Click "Download CSV" for complete data.</p>`;
        }
        
        resultsDiv.innerHTML = html;
        document.getElementById('downloadBtn').disabled = false;
        window.tradeData = allData;
        
      } else {
        resultsDiv.innerHTML = `
          <div style="background: #fff3cd; padding: 15px; border-radius: 8px;">
            <h3 style="color: #856404;">No Data Found</h3>
            <p>No trade data was found. Please check:</p>
            <ul>
              <li>HTS codes are valid 10-digit codes</li>
              <li>Date range is valid</li>
              <li>Try without country filter first</li>
            </ul>
          </div>
        `;
      }
      
      // Show results card
      document.querySelector('.dynamic-card').style.display = 'block';
    }

    // ========================================
    // CSV DOWNLOAD FUNCTION
    // ========================================
    function downloadCSV() {
      if (!window.tradeData || window.tradeData.length === 0) {
        alert('No data to download');
        return;
      }
      
      // Create CSV content
      const headers = ['HTS_CODE', 'CTY_CODE', 'CTY_NAME', 'YEAR', 'MONTH', 'GEN_VAL_MO', 'CON_VAL_MO', 'GEN_QY1_MO', 'UNIT_QY1'];
      let csv = headers.join(',') + '\n';
      
      window.tradeData.forEach(row => {
        const values = headers.map(h => {
          const val = row[h] || '';
          // Escape commas and quotes
          return val.toString().includes(',') ? `"${val}"` : val;
        });
        csv += values.join(',') + '\n';
      });
      
      // Create download link
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `trade_data_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
    }

    // ========================================
    // EVENT LISTENERS
    // ========================================
    document.addEventListener('DOMContentLoaded', () => {
      // Connect to API on page load
      connectToAPI();
      
      // Fetch button
      document.getElementById('fetchBtn').addEventListener('click', fetchData);
      
      // Download button
      document.getElementById('downloadBtn').addEventListener('click', downloadCSV);
      
      // Add country button
      document.getElementById('addCountryBtn').addEventListener('click', () => {
        const searchInput = document.getElementById('countrySearch');
        const searchText = searchInput.value.toLowerCase().trim();
        const select = document.getElementById('countrySelect');
        const options = select.options;
        
        if (searchText) {
          for (let i = 0; i < options.length; i++) {
            const opt = options[i];
            if (!opt.value) continue;
            if (opt.textContent.toLowerCase().includes(searchText)) {
              opt.selected = true;
              select.value = opt.value;
              if (typeof opt.scrollIntoView === 'function') {
                opt.scrollIntoView({ block: 'nearest' });
              }
              break;
            }
          }
        }
        
        const selectedOpts = Array.from(options).filter(opt => opt.selected && opt.value);
        selectedOpts.forEach(opt => {
          const exists = selectedCountriesList.some(entry => entry.code === opt.value);
          if (!exists) {
            selectedCountriesList.push({ code: opt.value, name: opt.textContent });
          }
        });
        
        renderSelectedCountries();
        searchInput.value = '';
      });
      
      // Remove country button
      document.getElementById('removeCountryBtn').addEventListener('click', () => {
        const selectBox = document.getElementById('selectedCountrySelect');
        if (!selectBox) return;
        
        const selected = Array.from(selectBox.selectedOptions);
        if (selected.length === 0) return;
        
        const countrySelect = document.getElementById('countrySelect');
        selected.forEach(opt => {
          const code = opt.value;
          selectedCountriesList = selectedCountriesList.filter(entry => entry.code !== code);
          Array.from(countrySelect.options).forEach(o => {
            if (o.value === code) {
              o.selected = false;
            }
          });
        });
        
        renderSelectedCountries();
      });
      
      // Country search on type
      const searchBox = document.getElementById('countrySearch');
      const countrySelect = document.getElementById('countrySelect');
      if (searchBox && countrySelect) {
        searchBox.addEventListener('input', () => {
          const term = searchBox.value.toLowerCase().trim();
          const opts = Array.from(countrySelect.options);
          opts.forEach(opt => { opt.selected = false; });
          
          if (!term) return;
          
          for (const opt of opts) {
            if (!opt.value) continue;
            if (opt.textContent.toLowerCase().includes(term)) {
              opt.selected = true;
              countrySelect.value = opt.value;
              if (typeof opt.scrollIntoView === 'function') {
                opt.scrollIntoView({ block: 'nearest' });
              }
              break;
            }
          }
        });
      }
    });

    // ========================================
    // SUCCESS MESSAGE
    // ========================================
    console.log('%c🔒 TradeVRS Application Loaded!', 'color: green; font-size: 16px; font-weight: bold;');
    console.log('%cCountry codes and units are protected by backend API', 'color: blue; font-size: 12px;');
  </script>
</body>
</html>